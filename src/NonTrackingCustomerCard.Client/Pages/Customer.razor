@page "/customer"
@using NonTrackingCustomerCard.Client.Contracts
@inject IJSRuntime JS
@inject NavigationManager Navigation

<h3>Kunde</h3>

<h4>Willkommen bei @customerOfVendor.OfVendor.Name!</h4>

<canvas id="qrcode" class="qr-code-container" @onclick="NavigateToScanUpdate"></canvas>

<style>
    html, body, article  {
        height: 100%;
        margin: 0;
    }
    .qr-code-container {
        width: 100%;
        height: 100%;
        object-fit: contain;
    }
</style>


@code {
    private CustomerDataWithSignature customer = new();
    private CustomerOfVendorData customerOfVendor = new();

    protected override async Task OnInitializedAsync()
    {
        var customerJson = await JS.InvokeAsync<string>("localStorage.getItem", "NonTrackingCustomerCard.Client.Customer");
        if (!string.IsNullOrEmpty(customerJson))
        {
            customerOfVendor = System.Text.Json.JsonSerializer.Deserialize<CustomerOfVendorData>(customerJson) ?? new CustomerOfVendorData();
            customer = System.Text.Json.JsonSerializer.Deserialize<CustomerDataWithSignature>(customerJson) ?? new CustomerDataWithSignature();
        }
        else
        {
            Navigation.NavigateTo("/customer/scanvendor");
        }
    }

    override protected async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JS.InvokeVoidAsync("qrGenerator.initializeQrCode", "qrcode");
        }

        if (customer != null)
            await JS.InvokeAsync<string>("qrGenerator.generateQrCode", customer);
    }

    private void NavigateToScanUpdate()
    {
        Navigation.NavigateTo("/customer/scanupdate");
    }
}